{% extends 'MottaPgBundle:Paginator:layouts/paginator_simple.html.twig' %}

{% block javascripts %}
    {{ parent() }}
    <script type="text/javascript">
    $(function () {
        var form = "{{ paginator.id }}"
        var pageForm = "{{ paginator.form.page.vars.id }}"
        var pageVal = "{{ paginator.form.vars.value.page }}"
        var totalPages = "{{ paginator.totalPages }}"
        var totalRows = "{{ paginator.totalRows }}"
        var cantForm = "{{ paginator.form.rowsPerPage.vars.id }}"
        var orderByForm = "{{ paginator.form.orderBy.vars.id }}"
        var orderByVal = "{{ paginator.form.vars.value.orderBy }}"
        var directionForm = "{{ paginator.form.direction.vars.id }}"
        var directionVal = "{{ paginator.form.vars.value.direction }}"
        var massIdsForm = "{{ paginator.form.massIds.vars.id }}"
        var massIdsVal = "{{ paginator.form.vars.value.massIds }}"
        var massAllForm = "{{ paginator.form.massAll.vars.id }}"
        var massAllVal = "{{ paginator.form.vars.value.massAll }}"
        var showPageNav = "{{ paginator.hide.pageNav }}"

        function validarBotonesPag() {
            if (totalPages <= 1 && !showPageNav) {
                $('#'+form+" .page-nav").addClass('hide')
            } else {
                $('#'+form+" .page-nav").removeClass('hide')
            }
            $("#prevPage-{{ paginator.id }}").attr('disabled',
                  (+$("#{{ paginator.id }} #"+pageForm).val() <= 1))
            $("#nextPage-{{ paginator.id }}").attr('disabled',
                ( parseInt(totalPages) <= parseInt(pageVal) ))
            $("#lastPage-{{ paginator.id }}").attr('disabled',
                ( parseInt(totalPages) <= parseInt(pageVal) ))
            $("#firstPage-{{ paginator.id }}").attr('disabled',
                (+$("#{{ paginator.id }} #"+pageForm).val() <= 1))
        }

        function limpiarMassIds() {
            $("#{{ paginator.id }} #"+massIdsForm).val('')
            massIdsVal = null
            $("#{{ paginator.id }} #"+massAllForm).val(false)
            massAllVal = false
        }

        function checkearSeleccionados() {
            if ($("#{{ paginator.id }} #"+massAllForm).val() && $("#{{ paginator.id }} #"+massAllForm).val() == 'true') {
                $("#{{ paginator.id }} #seleccionados-count").text(totalRows)
                $("#{{ paginator.id }} #massaction-all").attr('checked', true)
                $("#{{ paginator.id }} .massaction").each(function(index, el) {
                    this.checked = true
                });
            }
            else {
                if ($("#{{ paginator.id }} #"+massIdsForm).val()) {
                    var arr = $("#{{ paginator.id }} #"+massIdsForm).val().split('#')
                    for (var i = 0; i < arr.length; i++) {
                        $("#{{ paginator.id }} #massaction"+arr[i]).attr('checked', 'checked')
                    }
                    var count = arr.length
                    if (arr.length > 0 && arr[0] == "") {
                        count--
                    }
                    $("#{{ paginator.id }} #seleccionados-count").text(count)
                }
                else {
                    $("#{{ paginator.id }} #seleccionados-count").text(0)
                }
            }
        }

        function loaderBoton(active = true) {
            var contenido = active ?
                            '<i class="fa fa-spinner fa-spin"></i> Buscando...'
                            :
                            'Buscar'
            $("#buscar-{{ paginator.id }}").html(contenido)
        }
        var pgruta = ""
        function submitear () {
            $("#loader-{{ paginator.id }}").removeClass('hide')
            $("#tabla-{{ paginator.id }} table").addClass('cargando')
            $.ajax({
                url: "{{ path(ajax_route, ajax_params) }}",
                type: 'post',
                data: $("#{{ paginator.id }}").serialize(),
            })
            .done(function(data) {
                $("#table-container-{{ paginator.id }}").removeClass('hide')
                $("#tabla-body-{{ paginator.id }}").html(data['html'])
                $("#actualPage-{{ paginator.id }}").text($("#{{ paginator.id }} #"+pageForm).val())
                $("#totalRows-{{ paginator.id }}").text(data['totalRows'])
                $("#totalPages-{{ paginator.id }}").text(data['totalPages'])

                $("#"+form+" #"+limpiarForm).val(false)
                limpiarVal = false
                totalPages = data['totalPages']
                pageVal = $("#{{ paginator.id }} #"+pageForm).val()
                validarBotonesPag()

                loaderBoton(false)
                $("#loader-{{ paginator.id }}").addClass('hide')
                $("#tabla-{{ paginator.id }} table").removeClass('cargando')
                checkearSeleccionados()
            })
            .fail(function(err) {
                console.error("error", err);
            })
        }

        validarBotonesPag()
        $("#prevPage-{{ paginator.id }}").click(function () {
            $("#{{ paginator.id }} #"+pageForm).val(+$("#{{ paginator.id }} #"+pageForm).val() - 1)
            submitear()
        })
        $("#nextPage-{{ paginator.id }}").click(function () {
            $("#{{ paginator.id }} #"+pageForm).val(+$("#{{ paginator.id }} #"+pageForm).val() + 1)
            submitear()
        })
        $("#firstPage-{{ paginator.id }}").click(function () {
            $("#{{ paginator.id }} #"+pageForm).val(1)
            submitear()
        })
        $("#lastPage-{{ paginator.id }}").click(function () {
            $("#{{ paginator.id }} #"+pageForm).val(totalPages)
            submitear()
        })
        $("#{{ paginator.id }} #"+cantForm).change(function () {
            $("#{{ paginator.id }} #"+pageForm).val(1)
            submitear()
        })
        $("#ordenar-{{ paginator.id }}").click(function () {
            $("#{{ paginator.id }} #"+pageForm).val(1)
            submitear()
        })

        $("#buscar-{{ paginator.id }}").click(function () {
            loaderBoton()
            $("#{{ paginator.id }} #"+pageForm).val(1)
            limpiarMassIds()
            submitear()
        })
        $("#limpiar-{{ paginator.id }}").click(function () {
            $("#filtros-{{ paginator.id }} :input").val('')
        })
        $("#filtros-{{ paginator.id }} :input").keypress(function (e) {
            if (e.keyCode == 13) {
                limpiarMassIds()
                submitear()
            }
        })

        $('th.ordenable').each(function () {
            var by = $(this).attr('sort')
            if (by == orderByVal) {
                $(this).attr('orden', ordenVal)
                $(this).append('<i class="fa fa-sort-'+ordenVal+'"></i>')
            }
        })
        $('th.ordenable').click(function () {
            var by = $(this).attr('sort')
            var orden = $(this).attr('orden')
            $("#"+orderByForm).val(by)
            $("#"+pageForm).val(1)
            if (orden) {
                $(this).find('i.fa').toggleClass('fa-sort-asc fa-sort-desc')
                orden = orden == 'asc' ? 'desc' : 'asc'
                $(this).attr('orden', orden)
                $("#"+ordenForm).val(orden)
            }
            else {
                $('th.ordenable').removeAttr('orden')
                $('th.ordenable i.fa').remove()
                $(this).attr('orden', ordenVal)
                $("#"+ordenForm).val(ordenVal)
                $(this).append('<i class="fa fa-sort-'+ordenVal+'"></i>')
            }
            submitear()
        });

        limpiarMassIds()
        checkearSeleccionados()

        $("#panel-filtro-{{ paginator.id }}").click(function () {
            $("#flecha-{{ paginator.id }}").toggleClass('fa-chevron-down fa-chevron-up')
        })

        $('[data-toggle="tooltip"]').tooltip()

        $(document).on('click', '.massaction',function (e) {
            var valor = $(this).val()
            if ($(this).is(':checked')) {
                $("#{{ paginator.id }} #"+massIdsForm).val($("#{{ paginator.id }} #"+massIdsForm).val()+'#'+valor)
                var count = parseInt($("#{{ paginator.id }} #seleccionados-count").text()) + 1
            }
            else {
                var arr = []
                if ($("#{{ paginator.id }} #"+massAllForm).val() == 'true') {
                    $("#{{ paginator.id }} #"+massAllForm).val(false)
                    $('#massaction-all').attr('checked', false)
                    $('.massaction:checked').each(function(index, el) {
                        arr.push(this.value)
                    });
                    var count = arr.length
                }
                else {
                    arr = $("#{{ paginator.id }} #"+massIdsForm).val().split('#')
                    var index = arr.indexOf(valor)
                    arr.splice(index, 1)
                    var count = arr.length
                    if (arr.length > 0 && arr[0] == "") {
                        count--
                    }
                }
                var resultado = arr.join('#')
                $("#{{ paginator.id }} #"+massIdsForm).val(resultado)
            }
            $("#{{ paginator.id }} #seleccionados-count").text(count)
        })

        $(document).on('click', '#massaction-all', function (e) {
            var acc = this.checked ? true : false
            $("#{{ paginator.id }} #"+massAllForm).val(acc)
            massAllVal = acc
            $("#{{ paginator.id }} .massaction").each(function(index, el) {
                this.checked = acc
            })
            if (acc) {
                var count = totalRows
            }
            else {
                limpiarMassIds()
                var count = 0
            }
            $("#{{ paginator.id }} #seleccionados-count").text(count)
        })

        $(document).on('click', '.dropdown .action', function (e) {
            e.preventDefault()
            if ($("#{{ paginator.id }} #seleccionados-count").text() == '0') {
                $("#{{ paginator.id }} #mass-count-error").removeClass('hide')
                setTimeout(function () {
                    $("#{{ paginator.id }} #mass-count-error").addClass('hide')
                }, 2500)
            } else {
                var modal = $(this).attr('modal')
                var action = pgruta +"?mass=" + $(this).attr('id')
                var x = $("#{{ paginator.id }}").attr('action')
                var i = x.indexOf('?')
                if (i > -1) {
                    x = x.substr(0, i)
                }
                $("#{{ paginator.id }}").attr('action', x+action)
                if (modal != '') {
                    $('#'+modal).modal('show')
                } else {
                    $("#{{ paginator.id }}").submit()
                }
            }
        })

        $(".modal-cancelar-{{ paginator.id }}").click(function () {
            var action = $("#{{ paginator.id }}").attr('action')
            var i = action.indexOf('?')
            if (i > -1) {
                action = action.substr(0, i)
            }
            $("#{{ paginator.id }}").attr('action', action)
        })
    })
    </script>
{% endblock %}
